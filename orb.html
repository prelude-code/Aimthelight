<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Orb Wall — Aim the Light</title>
<meta name="description" content="A living orb of light shaped by our reflections." />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1020; --ink:#f8fafc; --muted:#94a3b8; --accent:#fbbf24; --card:#111827; --soft:#1f2937;
    --max:1200px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:var(--accent);text-decoration:none}

  header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,0));backdrop-filter:saturate(120%) blur(6px)}
  .nav{display:flex;justify-content:space-between;align-items:center;padding:12px 16px}
  .brand{font-weight:800}
  .nav a.btn{background:var(--accent);color:#0b0b0b;padding:.45rem .75rem;border-radius:10px;font-weight:600}

  .hero{display:grid;place-items:center;text-align:center;min-height:22vh;border-bottom:1px solid #1f2737;position:relative;isolation:isolate}
  .hero::before{
    content:"";position:absolute;inset:0;z-index:-1;
    background:
      radial-gradient(900px 420px at 70% 0%, rgba(251,191,36,.18), transparent 60%),
      radial-gradient(700px 400px at 10% 30%, rgba(96,165,250,.12), transparent 60%);
  }
  .hero h1{font-size:clamp(2rem,1.3rem + 2vw,3rem);margin:.2rem 0 .2rem;font-weight:800}
  .hero p{color:var(--muted);max-width:760px;margin:.2rem auto}

  .scene-wrap{position:relative}
  /* Deeper backdrop; Upgrade Pack A */
  #scene2d {
    display:block; width:100vw;
    background:
      radial-gradient(1000px 500px at 60% -10%, rgba(251,191,36,.16), transparent 60%),
      radial-gradient(800px 420px at 10% 30%, rgba(96,165,250,.10), transparent 60%),
      #060913;
  }

  /* Floating composer HUD */
  .hud{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:18px; z-index:10; width:min(100%, var(--max)); padding:0 16px;
  }
  .composer{
    display:grid; gap:10px; grid-template-columns: 1fr 280px;
    background:linear-gradient(180deg, rgba(17,24,39,.85), rgba(12,19,34,.9));
    border:1px solid #243044; border-radius:16px; padding:12px;
    backdrop-filter: blur(4px); box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  @media (max-width:860px){ .composer{grid-template-columns:1fr} }
  textarea,input,select{
    width:100%; border:1px solid #2b3a52; border-radius:12px; background:#0c1322;
    color:#e5e7eb; padding:10px 12px; font-size:1rem; outline:none;
  }
  textarea{min-height:84px;resize:vertical}
  .rightcol{display:grid; gap:10px; grid-template-columns:1fr}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:.35rem;border:1px solid #344155;background:rgba(17,24,39,.5);padding:.35rem .6rem;border-radius:999px;color:var(--ink);font-weight:600}
  .btn{background:var(--accent);color:#0b0b0b;padding:.55rem .95rem;border-radius:12px;border:none;font-weight:800;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .muted{color:var(--muted);font-size:.9rem}
  .counter{font-variant-numeric:tabular-nums}

  /* Mini feed */
  .feed{
    list-style:none; margin:8px 0 0; padding:0; max-height:140px; overflow:auto;
    border:1px solid #243044; border-radius:10px; background:rgba(12,19,34,.6);
  }
  .feed li{
    padding:.45rem .6rem; border-bottom:1px solid rgba(36,48,68,.6);
    font-size:.95rem; color:#e5e7eb;
    display:flex; gap:.35rem; align-items:baseline;
  }
  .feed li:last-child{ border-bottom:0; }
  .feed .who{ color:#94a3b8; margin-right:.35rem; font-weight:600; }

  footer{padding:42px 0;border-top:1px solid #1f2737;text-align:center;color:var(--muted)}

  /* Toast */
  .toast {
    position: fixed;
    left: 50%;
    bottom: 100px;
    transform: translateX(-50%);
    background: rgba(17,24,39,.9);
    border: 1px solid #243044;
    color: #f8fafc;
    padding: 10px 14px;
    border-radius: 12px;
    font-weight: 600;
    box-shadow: 0 10px 30px rgba(0,0,0,.35);
    z-index: 100;
    opacity: 0;
    transition: opacity .2s ease, transform .2s ease;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(-6px); }

  /* Tiny top-right HUD (Upgrade Pack C) */
  #hudTop {
    position:fixed; right:12px; top:62px; z-index:9;
    background:rgba(17,24,39,.75); border:1px solid #243044; border-radius:12px;
    padding:10px 12px; font-weight:600; color:#f8fafc; backdrop-filter:blur(4px);
  }
  #moodNow{ font-size:.9rem; color:#94a3b8 }
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><a href="index.html" style="color:inherit;text-decoration:none">Aim the Light</a></div>
    <nav class="links" aria-label="Primary">
      <a class="muted" href="index.html#mission">Mission</a>
      &nbsp;·&nbsp;<a class="muted" href="essay.html">Essay</a>
      &nbsp;·&nbsp;<a class="muted" href="hub.html">Hub</a>
    </nav>
    <a class="btn" href="index.html#join">Join</a>
  </div>
</header>

<section class="hero">
  <h1>A Living Orb of Light</h1>
  <p>Your reflections become sparks that orbit a shared world. The orb’s color shifts with our collective mood.</p>
</section>

<div class="scene-wrap">
  <canvas id="scene2d"></canvas>
</div>

<!-- Tiny live HUD -->
<div id="hudTop">
  <div id="countTotal">0 lights</div>
  <div id="moodNow">mood: —</div>
</div>

<!-- Floating composer -->
<div class="hud">
  <div class="composer">
    <textarea id="msg" maxlength="160" placeholder="Light is... (max 160)"></textarea>
    <div class="rightcol">
      <input id="name" type="text" placeholder="Name (optional)" />
      <select id="tone">
        <option value="">Tag (optional)</option>
        <option>Hope</option><option>Resolve</option><option>Gratitude</option>
        <option>Clarity</option><option>Action</option>
      </select>
      <div class="row">
        <span class="chip counter" id="count">0/160</span>
        <span class="muted" id="hint"></span>
        <div style="flex:1"></div>
        <button class="btn" id="postBtn" disabled>Add to the Light</button>
      </div>
      <ul id="feed" class="feed"></ul>
    </div>
  </div>
</div>

<footer>
  <p>© <span id="y"></span> Aim the Light • <a href="mailto:info@aimthelight.org">info@aimthelight.org</a></p>
</footer>

<script>
/* ====== UTIL + STORAGE ====== */
document.getElementById('y').textContent = new Date().getFullYear();

const STORE_KEY = 'atl_orb_posts_v1';
const RATE_KEY  = 'atl_orb_last_ms';
const TONES = {
  'Hope':      { col: '#fbbf24' },
  'Resolve':   { col: '#ef4444' },
  'Gratitude': { col: '#22c55e' },
  'Clarity':   { col: '#60a5fa' },
  'Action':    { col: '#a78bfa' }
};
const DEFAULT_COL = '#ffe8a6';

function loadPosts(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||'[]'); }catch{ return []; } }
function savePosts(list){ localStorage.setItem(STORE_KEY, JSON.stringify(list)); }
function esc(s){
  return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))
                 .replace(/'/g,'&#39;');
}

/* ====== SEED (Upgrade Pack B) ====== */
const SHOW_SEED = true;
const SEED = [
  {text:'Light is listening before judging.', tone:'Clarity', name:'Ava'},
  {text:'Light is courage in public and humility in private.', tone:'Resolve', name:'D.'},
  {text:'Light is the pause that prevents a scar.', tone:'Hope'},
  {text:'Light is what we owe each other on our worst day.', tone:'Gratitude'},
  {text:'Light is choosing curiosity over certainty.', tone:'Action'}
];
(function seed(){
  if (!SHOW_SEED) return;
  const have = loadPosts();
  if (have && have.length) return;
  const now = Date.now();
  const seeded = SEED.map((s,i)=>({
    id: 'seed_'+i, text: s.text, name: s.name||'',
    tone: s.tone||'', col: (TONES[s.tone]?.col || DEFAULT_COL),
    ts: now - (SEED.length - i) * 60000
  }));
  savePosts(seeded);
})();

/* ====== 2D ORB SCENE ====== */
const canvas = document.getElementById('scene2d');
const ctx    = canvas.getContext('2d', { alpha: true });

function calcSceneHeight(){
  const reserve = (window.innerWidth < 860) ? 220 : 160; // for HUD
  const heroH   = Math.max(140, window.innerHeight * 0.22);
  return Math.floor(Math.max(300, window.innerHeight - heroH - reserve));
}
function sizeCanvas(){
  const w = window.innerWidth;
  const h = calcSceneHeight();
  const dpr = Math.min(devicePixelRatio || 1, 2);
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';
  canvas.width = Math.floor(w * dpr);
  canvas.height = Math.floor(h * dpr);
}
sizeCanvas();
window.addEventListener('resize', sizeCanvas);

// orbits & particles
let orbits = [];
let particles = [];        // Upgrade Pack A
let starDrift = 0;         // drifting stars
let lastMouse = {x:0.5, y:0.3}; // parallax glow

canvas.addEventListener('pointermove', (e)=>{
  lastMouse.x = e.clientX / Math.max(1, window.innerWidth);
  lastMouse.y = e.clientY / Math.max(1, canvas.getBoundingClientRect().height);
});

function addOrbit(p){
  const rad   = 120 + Math.random()*70;
  const angle = Math.random()*Math.PI*2;
  const speed = 0.0008 + Math.random()*0.0018;
  orbits.push({ p, rad, angle, speed });
}
function rebuild(){
  orbits = [];
  loadPosts().sort((a,b)=>a.ts-b.ts).forEach(addOrbit);
}
rebuild();

function moodColor(){
  const list = loadPosts();
  if (!list.length) return '#fbbf24';
  const counts = {Hope:0,Resolve:0,Gratitude:0,Clarity:0,Action:0, Unknown:0};
  list.forEach(p => { const t = p.tone || 'Unknown'; counts[t] = (counts[t]||0) + 1; });
  const total = Object.values(counts).reduce((a,b)=>a+b,0)||1;
  const weights = [
    {c:'#fbbf24', w:counts.Hope/total},
    {c:'#ef4444', w:counts.Resolve/total},
    {c:'#22c55e', w:counts.Gratitude/total},
    {c:'#60a5fa', w:counts.Clarity/total},
    {c:'#a78bfa', w:counts.Action/total},
    {c:'#ffcc88', w:(counts.Unknown/total)*0.5},
  ];
  let r=0,g=0,b=0;
  function hex2rgb(hex){ const n=parseInt(hex.slice(1),16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
  weights.forEach(({c,w})=>{ const {r:rr,g:gg,b:bb}=hex2rgb(c); r+=rr*w; g+=gg*w; b+=bb*w; });
  r=Math.round(r); g=Math.round(g); b=Math.round(b);
  return `rgb(${r},${g},${b})`;
}

/* Upgrade Pack A: particles + fancy tick */
let last = performance.now();
function tick(t){
  const dpr = Math.min(devicePixelRatio || 1, 2);
  const dt = t - last; last = t;
  const w = canvas.width, h = canvas.height, cx = w/2, cy = h/2;

  // subtle trails
  ctx.setTransform(1,0,0,1,0,0);
  ctx.globalCompositeOperation = 'source-over';
  ctx.fillStyle = 'rgba(6,9,19,0.18)';
  ctx.fillRect(0,0,w,h);

  // drifting stars
  starDrift += dt * 0.00005;
  ctx.save();
  ctx.globalAlpha = 0.85;
  ctx.fillStyle = '#ffffff';
  for(let i=0;i<120;i++){
    const sx = (Math.sin(i*12.33 + starDrift)*0.5+0.5) * w;
    const sy = (Math.cos(i*7.71  + starDrift)*0.5+0.5) * h;
    const s  = (Math.sin(i*3.1 + starDrift*6)*0.5+0.5) * 1.6 + 0.2;
    ctx.fillRect(sx, sy, s, s);
  }
  ctx.restore();

  // mood glow with parallax
  const mood = moodColor();
  const gx = cx + (lastMouse.x-0.5) * 140*dpr;
  const gy = cy + (lastMouse.y-0.5) * 120*dpr;
  const grad = ctx.createRadialGradient(gx, gy, 10*dpr, cx, cy, 200*dpr);
  grad.addColorStop(0, mood.replace('rgb','rgba').replace(')', ',0.25)'));
  grad.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.arc(cx, cy, 200*dpr, 0, Math.PI*2);
  ctx.fill();

  // orb body + emissive pulse
  const pulse = (Math.sin(t*0.0018)+1)/2; // 0..1
  const orbGrad = ctx.createRadialGradient(cx-50*dpr, cy-60*dpr, 10*dpr, cx, cy, (120+12*pulse)*dpr);
  orbGrad.addColorStop(0, '#223157');
  orbGrad.addColorStop(1, '#0b1020');
  ctx.fillStyle = orbGrad;
  ctx.beginPath();
  ctx.arc(cx, cy, (100+3*pulse)*dpr, 0, Math.PI*2);
  ctx.fill();

  // posts
  ctx.font = `${14*dpr}px Inter, system-ui, sans-serif`;
  orbits.forEach(o=>{
    o.angle += o.speed * dt;
    const x = cx + Math.cos(o.angle) * o.rad*dpr * 0.6;
    const y = cy + Math.sin(o.angle*0.6) * 18*dpr + Math.sin(o.angle) * o.rad*dpr * 0.22;

    // connection line to orb
    ctx.save();
    ctx.globalAlpha = 0.10;
    ctx.strokeStyle = mood;
    ctx.lineWidth = 1*dpr;
    ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(x, y); ctx.stroke();
    ctx.restore();

    // dot
    ctx.fillStyle = '#ffe8a6';
    ctx.beginPath(); ctx.arc(x, y, 3*dpr, 0, Math.PI*2); ctx.fill();

    // label
    const label = (o.p.name ? `${o.p.name}: ` : '') + o.p.text;
    const pad = 8*dpr;
    const textW = Math.min(280*dpr, Math.max(120*dpr, ctx.measureText(label).width));
    const boxW  = textW + pad*2, boxH = 30*dpr;
    const bx = x + 12*dpr, by = y - boxH - 6*dpr;

    // card
    ctx.fillStyle = '#ffe8a6';
    roundRect(ctx, bx, by, boxW, boxH, 10*dpr); ctx.fill();
    ctx.strokeStyle = 'rgba(0,0,0,.18)'; ctx.lineWidth = 1*dpr; ctx.stroke();

    // text
    ctx.fillStyle = '#0b0b0b';
    ctx.fillText(label, bx + pad, by + 19*dpr - 10*dpr, textW);
  });

  // particles
  updateParticles(dt);
  drawParticles(ctx, dpr);

  requestAnimationFrame(tick);
}

function roundRect(ctx, x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
}

/* particles helpers */
function updateParticles(dt){
  for (let i = particles.length-1; i>=0; i--){
    const p = particles[i];
    p.life -= dt;
    if (p.life <= 0) { particles.splice(i,1); continue; }
    p.x += p.vx * (dt/16);
    p.y += p.vy * (dt/16);
    p.vy += 0.0008 * dt;
  }
}
function drawParticles(ctx, dpr){
  particles.forEach(p=>{
    const a = Math.max(0, Math.min(1, p.life / p.max));
    ctx.save();
    ctx.globalAlpha = 0.3 * a;
    ctx.fillStyle = p.col;
    ctx.beginPath(); ctx.arc(p.x, p.y, p.r * dpr, 0, Math.PI*2); ctx.fill();
    ctx.restore();
  });
}
function spawnBurst(x, y, col){
  for(let i=0;i<22;i++){
    particles.push({
      x, y,
      vx: (Math.random()*2-1)*0.15,
      vy: (Math.random()*2-1)*0.18,
      r: Math.random()*2+1,
      life: 800 + Math.random()*500,
      max: 1300,
      col
    });
  }
}

/* ====== FEED + COMPOSER ====== */
const feedEl = document.getElementById('feed');
function appendFeed(p){
  const li = document.createElement('li');
  const who = p.name ? `<span class="who">${esc(p.name)}:</span>` : '';
  li.innerHTML = `${who}${esc(p.text)}`;
  feedEl.insertBefore(li, feedEl.firstChild);
}
// preload feed
try { loadPosts().slice(-10).reverse().forEach(appendFeed); } catch {}

const msg   = document.getElementById('msg');
const nameI = document.getElementById('name');
const tone  = document.getElementById('tone');
const count = document.getElementById('count');
const hint  = document.getElementById('hint');
const postB = document.getElementById('postBtn');

const BADWORDS  = ['fuck','shit','bitch','asshole','cunt','nigger','faggot'];
const clean = t => !BADWORDS.some(w => (t||'').toLowerCase().includes(w));

function updateCounter(){
  const val = (msg.value || '').trim();
  const len = val.length;
  count.textContent = `${len}/160`;
  const enable = len > 0 && len <= 160 && clean(val);
  postB.disabled = !enable;
  if (!clean(val))        hint.textContent = 'Please keep it respectful.';
  else if (len > 160)     hint.textContent = 'Too long.';
  else                    hint.textContent = '';
}
['input','keyup','change','blur'].forEach(e=> msg.addEventListener(e, updateCounter));
tone.addEventListener('change', updateCounter);
setInterval(updateCounter, 500);
updateCounter();

function toast(text){
  let el = document.querySelector('.toast');
  if (!el){ el = document.createElement('div'); el.className='toast'; document.body.appendChild(el); }
  el.textContent = text;
  el.classList.add('show');
  setTimeout(()=> el.classList.remove('show'), 1200);
}

/* HUD (Upgrade Pack C) */
function moodName(){
  const list = loadPosts();
  if (!list.length) return 'warm';
  const tally = {Hope:0,Resolve:0,Gratitude:0,Clarity:0,Action:0};
  list.forEach(p=>{ if (tally[p.tone]!=null) tally[p.tone]++; });
  const best = Object.entries(tally).sort((a,b)=>b[1]-a[1])[0];
  return best && best[1]>0 ? best[0].toLowerCase() : 'mixed';
}
function refreshHUD(){
  const ct = document.getElementById('countTotal');
  const md = document.getElementById('moodNow');
  const n = (loadPosts()||[]).length;
  if (ct) ct.textContent = `${n} ${n===1?'light':'lights'}`;
  if (md) md.textContent = `mood: ${moodName()}`;
}
setInterval(refreshHUD, 1000);
refreshHUD();

/* Post handler */
postB.addEventListener('click', ()=>{
  const text = (msg.value || '').trim();
  if (!text || !clean(text)) { updateCounter(); return; }

  const now  = Date.now();
  const last = Number(localStorage.getItem(RATE_KEY)||0);
  const wait = 3000 - (now - last);
  if (wait>0){ hint.textContent = `Please wait ${Math.ceil(wait/1000)}s…`; return; }

  const t = tone.value || '';
  const col = TONES[t]?.col || DEFAULT_COL;
  const p = {
    id: (crypto.randomUUID ? crypto.randomUUID() : String(now)),
    text, name: (nameI.value||'').trim(), tone: t, col, ts: now
  };

  const list = loadPosts(); list.push(p); savePosts(list);
  localStorage.setItem(RATE_KEY, String(now));

  msg.value=''; nameI.value=''; tone.value=''; updateCounter();
  appendFeed(p);
  addOrbit(p);      // join the orbit
  refreshHUD();
  toast('Added to the Light ✨');

  // particle burst at orb center
  const cx = canvas.width/2, cy = canvas.height/2;
  spawnBurst(cx, cy, col);
});

/* Start render loop */
requestAnimationFrame(tick);
</script>
</body>
</html>