<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Empathy Wall — Aim the Light</title>
<meta name="description" content="A living pulse of what we need more of right now — add your word, see the wall breathe." />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,400;0,600;0,800;1,400&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1020; --ink:#f8fafc; --muted:#97a3b8; --accent:#fbbf24; --soft:#142038;
    --border:#23314f; --max:1100px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.6}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}
  .container{max-width:var(--max);margin:0 auto;padding:0 1.1rem}
  header{
    position:sticky;top:0;z-index:50;
    background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,0));
    backdrop-filter:saturate(120%) blur(6px);
    border-bottom:1px solid rgba(31,39,55,.35);
  }
  .nav{display:flex;justify-content:space-between;align-items:center;padding:8px 0;min-height:56px}
  header .container{padding:0 1.1rem}
  .brand a{white-space:nowrap;font-weight:800;font-size:1.05rem;color:inherit}
  nav.links{display:flex;gap:.9rem}
  nav.links a{color:var(--accent);font-weight:500}
  .hero{padding:48px 0 12px;border-bottom:1px solid #1b2742;text-align:center}
  .hero h1{margin:.2rem 0 .4rem;font-size:clamp(1.8rem,1.2rem + 2vw,2.6rem);font-weight:800}
  .hero p{color:var(--muted);max-width:760px;margin:.3rem auto 0}

  /* Prompt + form */
  .panel{margin:24px auto 8px;max-width:820px;border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,#0e1830,#0b1428)}
  .panel .row{display:flex;flex-wrap:wrap;gap:12px;padding:14px}
  .prompt{flex:1 1 280px;background:#0c162a;border:1px dashed #2b3b65;border-radius:10px;padding:10px 12px}
  .prompt small{color:#cbd5e1}
  .prompt .key{color:#ffe8a6;font-weight:700}
  .form{flex:1 1 420px;display:flex;gap:10px;align-items:center}
  input[type="text"]{flex:1 1 auto;background:#0c162a;border:1px solid #2a3a64;border-radius:10px;color:#e7eefb;padding:.7rem .8rem;font-size:1rem;outline:none}
  input[type="text"]::placeholder{color:#93a0bd}
  .name{max-width:200px}
  button{background:var(--accent);border:none;color:#101010;font-weight:800;border-radius:12px;padding:.7rem 1rem;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  .meta-row{display:flex;justify-content:space-between;align-items:center;padding:8px 14px 14px;color:#aeb8ce}
  .meta-row .count{font-variant-numeric:tabular-nums}
  .err{color:#ff9393;font-weight:600}
  .ok{color:#99ffcc}

  /* Two views */
  .views{display:flex;gap:10px;justify-content:center;margin:18px 0}
  .views button{background:transparent;color:#e7eefb;border:1px solid #334160}
  .views button.active{background:rgba(251,191,36,.12);border-color:var(--accent);color:#ffe8a6}

  /* Leaderboard + Board */
  .grid{display:grid;grid-template-columns: 2fr 3fr;gap:16px;align-items:start}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}

  .card{border:1px solid var(--border);border-radius:16px;overflow:hidden;background:linear-gradient(180deg,#101a30,#0b1222);box-shadow:0 10px 24px rgba(0,0,0,.28)}
  .card h3{margin:0;padding:12px 14px;border-bottom:1px solid #1c2640;font-size:1rem}
  .card .body{padding:12px}

  .leaderboard ol{list-style:decimal;margin:0;padding-left:22px}
  .leaderboard li{padding:6px 0;border-bottom:1px dashed #23314f}
  .leaderboard li:last-child{border-bottom:none}
  .leaderboard .count{color:#ffe8a6;font-weight:700;margin-left:8px}

  .board{display:flex;flex-wrap:wrap;gap:10px;min-height:160px}
  .tile{
    --scale:1;
    transform:scale(var(--scale));
    transition:transform .25s ease, box-shadow .25s ease, background-color .25s ease;
    padding:.55rem .7rem;border-radius:12px;
    background:rgba(251,191,36,.08);color:#ffe8a6;border:1px solid rgba(251,191,36,.4);
    box-shadow:0 0 12px rgba(251,191,36,.18);
    font-weight:700; letter-spacing:.2px;
  }
  .tile:hover{box-shadow:0 0 18px rgba(251,191,36,.34)}
  .tile .small{font-weight:600;color:#d7e3ff;margin-left:6px;opacity:.85}

  footer{padding:48px 0;border-top:1px solid #1c2742;text-align:center;color:#97a3b8;margin-top:30px}
</style>
</head>
<body>
  <!-- Header (match essay) -->
  <header>
    <div class="nav container">
      <div class="brand"><a href="index.html">Aim the Light</a></div>
      <nav class="links" aria-label="Primary">
        <a href="index.html#mission">Mission</a>
        <a href="index.html#approach">Approach</a>
        <a href="essay.html">Essay</a>
        <a href="index.html#volunteer">Volunteer</a>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="container">
      <h1>The Empathy Wall</h1>
      <p>Add one word that we need more of this week. Watch the wall breathe as others echo it.</p>
    </div>
  </section>

  <main class="container">
    <!-- Prompt + form -->
    <div class="panel">
      <div class="row">
        <div class="prompt">
          <strong>Prompt of the week</strong><br/>
          <div style="margin-top:6px">What do we need more of right now?</div>
          <small>Week: <span class="key" id="weekKey">…</span></small>
        </div>

        <form class="form" id="entryForm" autocomplete="off">
          <input id="term" type="text" placeholder="Your word (max 30 chars)" maxlength="30" required />
          <input id="name" class="name" type="text" placeholder="Name (optional)" maxlength="40" />
          <button id="submitBtn" type="submit">Add to the Light</button>
        </form>
      </div>
      <div class="meta-row">
        <div id="msg" aria-live="polite"></div>
        <div class="count"><span id="total">0</span> echoes this week</div>
      </div>
    </div>

    <!-- Views -->
    <div class="views">
      <button id="viewBoard" class="active" type="button">Board</button>
      <button id="viewStars" type="button" disabled title="Coming soon">Stars</button>
    </div>

    <!-- Data -->
    <div class="grid">
      <div class="card leaderboard">
        <h3>Top words</h3>
        <div class="body">
          <ol id="topList"></ol>
        </div>
      </div>

      <div class="card">
        <h3>This week’s wall</h3>
        <div class="body">
          <div id="board" class="board"></div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    © <span id="y"></span> Aim the Light • <a href="mailto:info@aimthelight.org">info@aimthelight.org</a>
  </footer>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  // ---------- Config ----------
  const SUPABASE_URL = "https://rksoyinnfwdstzgjgegv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJrc295aW5uZndkc3R6Z2pnZWd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzMyNzUsImV4cCI6MjA3NzcwOTI3NX0.EbBGdjGNi4idankMWFM5tHeA_51beQ7ybCTKb8WeCwo";
  const supabase = (SUPABASE_URL && SUPABASE_ANON_KEY)
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    : null;

  // ---------- Utilities ----------
  document.getElementById('y').textContent = new Date().getFullYear();

  function isoWeekKey(d=new Date()){
    // returns e.g. "2025-W45"
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = (date.getUTCDay() + 6) % 7;
    date.setUTCDate(date.getUTCDate() - dayNum + 3);
    const firstThu = new Date(Date.UTC(date.getUTCFullYear(),0,4));
    const week = 1 + Math.round(((date - firstThu) / 86400000 - 3 + ((firstThu.getUTCDay()+6)%7)) / 7);
    return `${date.getUTCFullYear()}-W${String(week).padStart(2,'0')}`;
  }
  const PROMPT_KEY = isoWeekKey();
  document.getElementById('weekKey').textContent = PROMPT_KEY;

  const msg = (t, cls='ok')=>{
    const el = document.getElementById('msg');
    el.className = cls;
    el.textContent = t;
    if (t) setTimeout(()=>{ el.textContent=''; el.className=''; }, 2200);
  };

  // Simple profanity gate (expand later)
  const BAD = ['fuck','shit','bitch','cunt','nigger','fag','retard'];
  const hasBad = s => BAD.some(x => s.includes(x));

  // ---------- Local fallback (if no Supabase) ----------
  const localKey = `empathywall_${PROMPT_KEY}`;
  function readLocal(){
    try{ return JSON.parse(localStorage.getItem(localKey)||'[]'); }catch{ return []; }
  }
  function writeLocal(arr){
    localStorage.setItem(localKey, JSON.stringify(arr));
  }

  // ---------- Data I/O ----------
  async function insertEntry(term, name){
    const row = { term, name, prompt_key: PROMPT_KEY };
    if (!supabase){
      const arr = readLocal();
      arr.push({ ...row, created_at: new Date().toISOString() });
      writeLocal(arr);
      return { data: row };
    }
    const { data, error } = await supabase.from('entries').insert(row).select().single();
    if (error) throw error;
    return { data };
  }

  async function fetchWeek(){
    if (!supabase){
      return readLocal();
    }
    const { data, error } = await supabase
      .from('entries')
      .select('term,name,created_at')
      .eq('prompt_key', PROMPT_KEY)
      .order('created_at', { ascending: false })
      .limit(2000);
    if (error) throw error;
    return data || [];
  }

  // ---------- Aggregation + Rendering ----------
  function aggregate(rows){
    const map = new Map();
    rows.forEach(r=>{
      const t = (r.term||'').toLowerCase().trim();
      if (!t) return;
      map.set(t, (map.get(t)||0) + 1);
    });
    const list = Array.from(map.entries()).map(([term,count])=>({term,count}));
    list.sort((a,b)=> b.count - a.count || a.term.localeCompare(b.term));
    return { total: rows.length, list };
  }

  function renderLeaderboard(list){
    const top = list.slice(0,10);
    const ol = document.getElementById('topList');
    ol.innerHTML = '';
    top.forEach(({term,count})=>{
      const li = document.createElement('li');
      li.innerHTML = `${escapeHtml(title(term))} <span class="count">×${count}</span>`;
      ol.appendChild(li);
    });
  }

  function renderBoard(list){
    const board = document.getElementById('board');
    board.innerHTML = '';
    if (list.length === 0){
      board.textContent = 'Be the first to add a word.';
      return;
    }
    const max = Math.max(...list.map(x=>x.count));
    list.forEach(({term,count}, i)=>{
      const d = document.createElement('div');
      d.className = 'tile';
      const scale = 0.9 + 0.6 * Math.sqrt(count / max);
      d.style.setProperty('--scale', scale.toFixed(3));
      d.style.opacity = 0.85 + 0.15 * (count/max);
      d.textContent = title(term);
      const small = document.createElement('span');
      small.className = 'small';
      small.textContent = `×${count}`;
      d.appendChild(small);
      d.style.transitionDelay = (i * 0.01) + 's';
      board.appendChild(d);
    });
  }

  // ---------- Form ----------
  const form = document.getElementById('entryForm');
  const termEl = document.getElementById('term');
  const nameEl = document.getElementById('name');
  const btn = document.getElementById('submitBtn');
  const totalEl = document.getElementById('total');

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    let term = (termEl.value||'').trim();
    let name = (nameEl.value||'').trim();
    if (!term) return msg('Please enter a word.', 'err');
    if (term.length > 30) return msg('Keep it to 30 characters.', 'err');
    if (hasBad(term.toLowerCase()) || hasBad(name.toLowerCase())) return msg('Please choose a kinder word.', 'err');

    term = term.replace(/\s+/g,' ').toLowerCase();

    btn.disabled = true;
    try{
      await insertEntry(term, name || null);
      termEl.value = ''; nameEl.value = '';
      msg('Added ✓','ok');
      await refresh();
    } catch(err){
      console.error(err);
      msg('Could not add right now. Try again.', 'err');
    } finally {
      btn.disabled = false;
      termEl.focus();
    }
  });

  // ---------- Refresh loop ----------
  async function refresh(){
    const rows = await fetchWeek();
    const { total, list } = aggregate(rows);
    totalEl.textContent = String(total);
    renderLeaderboard(list);
    renderBoard(list);
  }

  function title(s){ return s.charAt(0).toUpperCase() + s.slice(1); }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  (async function(){
    await refresh();
    setInterval(refresh, 20000);
  })();
  </script>
</body>
</html>