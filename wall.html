<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Lightwall — Aim the Light</title>
<meta name="description" content="Add your light: share one word or phrase the world needs more of this week." />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,400;0,600;0,800;1,400&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b1020; --ink:#f8fafc; --muted:#97a3b8; --accent:#fbbf24;
    --border:#23314f; --max:1200px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.6}
  a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
  .container{max-width:var(--max);margin:0 auto;padding:0 1.1rem}

  /* Header (match essay) */
  header{
    position:sticky;top:0;z-index:50;
    background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,0));
    backdrop-filter:saturate(120%) blur(6px);
    border-bottom:1px solid rgba(31,39,55,.35);
  }
  .nav{display:flex;justify-content:space-between;align-items:center;padding:8px 0;min-height:56px}
  .brand a{white-space:nowrap;font-weight:800;font-size:1.05rem;color:inherit;text-decoration:none}
  nav.links{display:flex;gap:.9rem}
  nav.links a{color:var(--accent);font-weight:500;text-decoration:none}

  /* Hero (no extra description) */
  .hero{padding:56px 0 18px;border-bottom:1px solid #1b2742;text-align:center}
  .hero h1{margin:.2rem 0 .2rem;font-size:clamp(1.9rem,1.2rem + 2vw,2.6rem);font-weight:800}

  /* Panel (prompt + form) */
  .panel{margin:26px auto 8px;max-width:920px;border:1px solid var(--border);
         border-radius:14px;background:linear-gradient(180deg,#0e1830,#0b1428);overflow:hidden}
  .panel .row{display:flex;flex-wrap:wrap;gap:12px;padding:14px;align-items:stretch}
  .prompt{flex:1 1 260px;background:#0c162a;border:1px dashed #2b3b65;border-radius:10px;padding:10px 12px}
  .prompt small{color:#cbd5e1}
  .prompt .key{color:#ffe8a6;font-weight:700}

  .form{flex:1 1 560px; min-width:0; display:flex; gap:10px; align-items:flex-end;}
  .form label{font-weight:700; color:var(--accent); font-size:.95rem; display:block; margin-bottom:.25rem}
  .input-col{flex:1 1 100%; min-width:0}
  input[type="text"]{
    width:100%; min-width:0; background:#0c162a; border:1px solid #2a3a64; border-radius:10px;
    color:#e7eefb; padding:.7rem .8rem; font-size:1rem; outline:none;
  }
  input::placeholder{color:#93a0bd}
  .name{max-width:260px}
  button{
    background:var(--accent); border:none; color:#101010; font-weight:800;
    border-radius:12px; padding:.7rem 1rem; cursor:pointer; white-space:nowrap;
  }
  button:disabled{opacity:.55;cursor:not-allowed}

  .meta-row{display:flex;justify-content:space-between;align-items:center;padding:8px 14px 14px;color:#aeb8ce}
  .meta-row .count{font-variant-numeric:tabular-nums}
  .err{color:#ff9393;font-weight:600}
  .ok{color:#99ffcc}

  @media (max-width:900px){
    .form{flex-wrap:wrap}
    .name{flex:1 1 100%;max-width:none}
    button#submitBtn{flex:1 1 100%}
  }

  /* Views */
  .views{display:flex;gap:10px;justify-content:center;margin:18px 0}
  .views button{background:transparent;color:#e7eefb;border:1px solid #334160}
  .views button.active{background:rgba(251,191,36,.12);border-color:var(--accent);color:#ffe8a6}

  /* Layout: leaderboard + wall */
  .grid{display:grid;grid-template-columns: 1fr 2.2fr;gap:18px;align-items:start}
  @media (max-width:1000px){.grid{grid-template-columns:1fr}}

  .card{border:1px solid var(--border);border-radius:16px;overflow:hidden;
        background:linear-gradient(180deg,#101a30,#0b1222);box-shadow:0 10px 24px rgba(0,0,0,.28)}
  .card h3{margin:0;padding:12px 14px;border-bottom:1px solid #1c2640;font-size:1rem}
  .card .body{padding:12px}

  .leaderboard ol{list-style:decimal;margin:0;padding-left:22px}
  .leaderboard li{padding:6px 0;border-bottom:1px dashed #23314f}
  .leaderboard li:last-child{border-bottom:none}
  .leaderboard .count{color:#ffe8a6;font-weight:700;margin-left:8px}

  /* WALL */
  .wall-wrap{
    position:relative; border:1px solid var(--border); border-radius:16px; overflow:hidden;
    background:
      radial-gradient(1200px 400px at 20% -10%, rgba(251,191,36,.08), transparent 60%),
      radial-gradient(900px 500px at 120% 10%, rgba(147,197,253,.08), transparent 60%),
      linear-gradient(180deg,#0f1830,#0b1222 60%, #0b1222);
    box-shadow:0 14px 28px rgba(0,0,0,.35);
  }
  .wall-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #1c2640}
  .wall-body{padding:18px 14px 26px}
  .board{
    display:flex; flex-wrap:wrap; gap:12px 12px;
    min-height:620px;
  }
  @media (max-width:900px){ .board{min-height:420px} }

  .chip{
    display:inline-flex; align-items:center; gap:.4rem;
    padding:.55rem .76rem; border-radius:14px;
    color:#0a0a0a; background:#ffe8a6; border:1px solid rgba(255,255,255,.18);
    box-shadow:0 6px 18px rgba(0,0,0,.24), inset 0 0 0 1px rgba(255,255,255,.08);
    line-height:1.15; font-weight:800; letter-spacing:.2px;
    white-space:nowrap; max-width:100%;
    transition:box-shadow .25s ease, transform .25s ease;
    opacity:0; transform:translateY(6px); /* start hidden for wave */
  }
  .chip .count{font-weight:700; opacity:.9}
  .chip[data-tone="light"]{ color:#0c0c0c }
  .chip[data-tone="dark"] { color:#f8fafc }
  .chip:hover{ box-shadow:0 10px 22px rgba(251,191,36,.28), inset 0 0 0 1px rgba(251,191,36,.5); transform:translateY(-1px) }

  /* --- Unlock "reveal" sequence --- */
  #wallSection { opacity:0; visibility:hidden; transform:translateY(8px); transition:opacity .5s ease, transform .5s ease, visibility .5s; }
  body.unlocked #wallSection { opacity:1; visibility:visible; transform:none; }

  #wallSection.unveil .card,
  #wallSection.unveil .wall-wrap {
    opacity:0; transform:translateY(24px); filter:blur(8px);
  }
  body.unlocked #wallSection.unveil .card,
  body.unlocked #wallSection.unveil .wall-wrap {
    animation: riseIn .9s ease forwards;
  }
  body.unlocked #wallSection.unveil .wall-wrap { animation-delay:.12s; }

  @keyframes riseIn { to { opacity:1; transform:none; filter:blur(0); } }

  body.revealed .board .chip { animation: chipIn .42s ease forwards; animation-delay: var(--d, 0s); }
  @keyframes chipIn { to { opacity:1; transform:none; } }

  /* Gold flash + +1 bubble on submitted chip */
  .chip.flash { animation: flashGold 1.1s ease; position: relative; z-index: 1; }
  @keyframes flashGold {
    0%   { box-shadow: 0 0 0 0 rgba(251,191,36,.9), 0 6px 18px rgba(0,0,0,.24); transform: scale(1.02); }
    45%  { box-shadow: 0 0 28px 10px rgba(251,191,36,.35), 0 10px 22px rgba(0,0,0,.28); }
    100% { box-shadow: 0 6px 18px rgba(0,0,0,.24); transform: none; }
  }
  .chip .pop {
    position:absolute; right:-12px; top:-6px;
    background:var(--accent); color:#0b0b0b; font-weight:800; font-size:.8rem;
    padding:.05rem .35rem; border-radius:999px; box-shadow:0 4px 12px rgba(251,191,36,.35);
    animation: floatUp 900ms ease forwards;
  }
  @keyframes floatUp {
    0% { opacity:0; transform: translateY(8px) scale(.9); }
    30%{ opacity:1; transform: translateY(0)   scale(1); }
    100%{ opacity:0; transform: translateY(-22px) scale(.98); }
  }

  /* LOCK/UNLOCK STATES */
  #wallSection[aria-hidden="true"] { pointer-events:none }
  #lockedHint{color:#aeb8ce; text-align:center; font-size:.95rem; margin:10px 0 0 0}

  footer{padding:48px 0;border-top:1px solid #1c2742;text-align:center;color:#97a3b8;margin-top:34px}
</style>
</head>
<body class="locked">
  <header>
    <div class="nav container">
      <div class="brand"><a href="index.html">Aim the Light</a></div>
      <nav class="links" aria-label="Primary">
        <a href="index.html#mission">Mission</a>
        <a href="index.html#approach">Approach</a>
        <a href="essay.html">Essay</a>
        <a href="index.html#volunteer">Volunteer</a>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="container">
      <h1>The Lightwall</h1>
      <!-- intentionally no descriptive paragraph below the title -->
    </div>
  </section>

  <main class="container">
    <!-- Prompt + form -->
    <div class="panel">
      <div class="row">
        <div class="prompt">
          <strong>Prompt of the week</strong><br/>
          <div style="margin-top:6px">What do we need more of right now?</div>
          <small>Week: <span class="key" id="weekKey">…</span></small>
        </div>

        <form class="form" id="entryForm" autocomplete="off">
          <div class="input-col">
            <label for="term">Share one word or phrase</label>
            <input id="term" type="text" placeholder="Enter a word or short phrase…" maxlength="60" required />
          </div>
          <input id="name" class="name" type="text" placeholder="Name (optional)" maxlength="40" />
          <button id="submitBtn" type="submit">Add to the Light</button>
        </form>
      </div>
      <div class="meta-row">
        <div id="msg" aria-live="polite"></div>
        <div class="count"><span id="total">0</span> echoes this week</div>
      </div>
      <div id="lockedHint">The wall appears after you submit your word or phrase. ✨</div>
    </div>

    <!-- Hidden until unlocked -->
    <section id="wallSection" aria-hidden="true">
      <div class="views">
        <button id="viewBoard" class="active" type="button">Board</button>
        <button id="viewStars" type="button" disabled title="Coming soon">Stars</button>
      </div>

      <div class="grid">
        <div class="card leaderboard">
          <h3>Top words</h3>
          <div class="body">
            <ol id="topList"></ol>
          </div>
        </div>

        <div class="wall-wrap">
          <div class="wall-head">
            <h3 style="margin:0;font-size:1rem">This week’s wall</h3>
            <div style="color:#cbd5e1;font-size:.95rem">Live • updates every 20s</div>
          </div>
          <div class="wall-body">
            <div id="board" class="board" aria-live="polite"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    © <span id="y"></span> Aim the Light • <a href="mailto:info@aimthelight.org">info@aimthelight.org</a>
  </footer>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  // ---------- Config ----------
  const SUPABASE_URL = "https://rksoyinnfwdstzgjgegv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJrc295aW5uZndkc3R6Z2pnZWd2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMzMyNzUsImV4cCI6MjA3NzcwOTI3NX0.EbBGdjGNi4idankMWFM5tHeA_51beQ7ybCTKb8WeCwo";
  const supabase = (SUPABASE_URL && SUPABASE_ANON_KEY)
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    : null;

  // ---------- Utils ----------
  document.getElementById('y').textContent = new Date().getFullYear();

  function isoWeekKey(d=new Date()){
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = (date.getUTCDay() + 6) % 7;
    date.setUTCDate(date.getUTCDate() - dayNum + 3);
    const firstThu = new Date(Date.UTC(date.getUTCFullYear(),0,4));
    const week = 1 + Math.round(((date - firstThu) / 86400000 - 3 + ((firstThu.getUTCDay()+6)%7)) / 7);
    return `${date.getUTCFullYear()}-W${String(week).padStart(2,'0')}`;
  }
  const PROMPT_KEY = isoWeekKey();
  const localUnlockKey = `lightwall_unlocked_${PROMPT_KEY}`;

  const BAD = ['fuck','shit','bitch','cunt','nigger','fag','retard'];
  const hasBad = s => BAD.some(x => s.includes(x));

  const msg = (t, cls='ok')=>{
    const el = document.getElementById('msg');
    el.className = cls;
    el.textContent = t;
    if (t) setTimeout(()=>{ el.textContent=''; el.className=''; }, 2200);
  };

  // Lock/Unlock helpers
  function isUnlocked(){ return localStorage.getItem(localUnlockKey) === '1'; }
  function unlockWall(){
    document.body.classList.add('unlocked');
    document.getElementById('wallSection').setAttribute('aria-hidden','false');
    localStorage.setItem(localUnlockKey, '1');
  }
  function lockWall(){
    document.body.classList.remove('unlocked');
    document.getElementById('wallSection').setAttribute('aria-hidden','true');
    localStorage.removeItem(localUnlockKey);
  }

  // Local fallback store
  function readLocal(){ try{ return JSON.parse(localStorage.getItem('lightwall_'+PROMPT_KEY)||'[]'); }catch{ return []; } }
  function writeLocal(arr){ localStorage.setItem('lightwall_'+PROMPT_KEY, JSON.stringify(arr)); }

  async function insertEntry(term, name){
    const row = { term, name, prompt_key: PROMPT_KEY };
    if (!supabase){
      const arr = readLocal(); arr.push({ ...row, created_at: new Date().toISOString() }); writeLocal(arr);
      return { data: row };
    }
    const { data, error } = await supabase.from('entries').insert(row).select().single();
    if (error) throw error;
    return { data };
  }

  async function fetchWeek(){
    if (!supabase) return readLocal();
    const { data, error } = await supabase
      .from('entries')
      .select('term,name,created_at')
      .eq('prompt_key', PROMPT_KEY)
      .order('created_at', { ascending: true })  // oldest first so we can identify first contributor
      .limit(2000);
    if (error) throw error;
    return data || [];
  }

  function aggregate(rows){
    const map = new Map();
    rows.forEach(r=>{
      const term = (r.term||'').toLowerCase().trim();
      if (!term) return;
      const name = (r.name||'').trim();
      const who  = name || 'Anonymous';
      const at   = r.created_at ? new Date(r.created_at).getTime() : 0;

      const entry = map.get(term);
      if (!entry) {
        map.set(term, { count:1, firstName: who, firstAt: at });
      } else {
        entry.count += 1;
        if (at && (entry.firstAt === 0 || at < entry.firstAt)) {
          entry.firstAt   = at;
          entry.firstName = who;
        }
      }
    });
    const list = Array.from(map.entries()).map(([term, info]) => ({ term, ...info }));
    list.sort((a,b)=> b.count - a.count || a.term.localeCompare(b.term));
    return { total: rows.length, list };
  }

  // Visual helpers
  function hashHue(str){
    let h = 0; for (let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i)) >>> 0;
    return h % 360;
  }
  function chipStyle(term){
    const h = hashHue(term);
    const s = 78; const l1 = 64, l2 = 42;
    const bg = `linear-gradient(135deg, hsl(${h} ${s}% ${l1}%) 0%, hsl(${(h+30)%360} ${s}% ${l2}%) 100%)`;
    const tone = l2 < 48 ? 'light' : 'dark';
    return { bg, tone };
  }
  function sizeFromCount(count, max){
    const min = 0.95, maxF = 1.9;
    const t = Math.sqrt(count / max || 1);
    return min + (maxF - min) * t;
  }
  function cap(s){ return s.charAt(0).toUpperCase() + s.slice(1); }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  function renderLeaderboard(list){
    const top = list.slice(0,12);
    const ol = document.getElementById('topList');
    ol.innerHTML = '';
    top.forEach(({term,count,firstName})=>{
      const li = document.createElement('li');
      li.innerHTML = `${escapeHtml(cap(term))} <span class="count">×${count}</span>`;
      li.title = `first by ${firstName || 'Anonymous'}`;
      ol.appendChild(li);
    });
  }

  function renderBoard(list){
    const board = document.getElementById('board');
    board.innerHTML = '';
    if (list.length === 0){ board.textContent = 'Be the first to add a word.'; return; }

    const max = Math.max(...list.map(x=>x.count));
    list.forEach(({term,count,firstName}, idx)=>{
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.dataset.term = term; // for flash targeting

      const { bg, tone } = chipStyle(term);
      chip.style.background = bg;
      chip.setAttribute('data-tone', tone);

      chip.style.fontSize = sizeFromCount(count, max).toFixed(2) + 'rem';
      chip.style.setProperty('--d', (idx * 0.02) + 's');  // wave delay

      chip.textContent = cap(term);
      const cnt = document.createElement('span');
      cnt.className = 'count';
      cnt.textContent = `×${count}`;
      chip.appendChild(cnt);

      chip.title = `${cap(term)} — first by ${firstName || 'Anonymous'}`;

      board.appendChild(chip);
    });
  }

  function animateCount(el, to, dur=700){
    const from = Number(el.textContent) || 0;
    if (to === from) return;
    const start = performance.now();
    function tick(now){
      const p = Math.min(1, (now - start) / dur);
      el.textContent = String(Math.floor(from + (to - from) * p));
      if (p < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  function flashChip(term){
    const chips = document.querySelectorAll('.board .chip');
    let target = null;
    chips.forEach(ch => {
      if ((ch.dataset.term || '').toLowerCase() === term.toLowerCase()) target = ch;
    });
    if (!target) return;

    target.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
    target.classList.add('flash');

    // +1 bubble
    const bub = document.createElement('span');
    bub.className = 'pop';
    bub.textContent = '+1';
    target.appendChild(bub);
    setTimeout(()=>{ bub.remove(); }, 950);

    setTimeout(()=> target.classList.remove('flash'), 1300);
  }

  async function refresh(){
    const rows = await fetchWeek();
    const { total, list } = aggregate(rows);
    animateCount(document.getElementById('total'), total);

    if (isUnlocked()) {
      renderLeaderboard(list);
      renderBoard(list);
    }
  }

  // Form + flow
  document.getElementById('weekKey').textContent = PROMPT_KEY;
  const form = document.getElementById('entryForm');
  const termEl = document.getElementById('term');
  const nameEl = document.getElementById('name');
  const btn = document.getElementById('submitBtn');

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    let term = (termEl.value||'').trim();
    let name = (nameEl.value||'').trim();
    if (!term) return msg('Please enter a word or short phrase.', 'err');
    if (term.length > 60) return msg('Keep it to 60 characters.', 'err');
    if (hasBad(term.toLowerCase()) || hasBad(name.toLowerCase())) return msg('Please choose a kinder word.', 'err');

    term = term.replace(/\s+/g,' ').toLowerCase();

    btn.disabled = true;
    try{
      await insertEntry(term, name || null);
      termEl.value = ''; nameEl.value = '';
      msg('Added ✓','ok');

      // Unlock + unveil sequence
      unlockWall();
      const ws = document.getElementById('wallSection');
      ws.classList.add('unveil');

      await refresh(); // populate before reveal
      ws.scrollIntoView({ behavior:'smooth', block:'start' });

      setTimeout(()=>{
        document.body.classList.add('revealed');
        ws.classList.remove('unveil');
        flashChip(term); // highlight the submitted one
      }, 250);
    } catch(err){
      console.error(err);
      msg('Could not add right now. Try again.', 'err');
    } finally {
      btn.disabled = false;
      termEl.focus();
    }
  });

  (async function init(){
    // Footer year
    document.getElementById('y').textContent = new Date().getFullYear();

    // If user already unlocked this week, show wall on load
    if (isUnlocked()) unlockWall();

    // Load data (will render only if unlocked)
    await refresh();

    // Keep fresh
    setInterval(refresh, 20000);
  })();
  </script>
</body>
</html>